<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>深入理解系列：zygote | 云枫飒的笔记BLOG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="其实文章的开始应该从jni开始才对，脑残的我写完却意外删除了。。。。等缓过来再补上吧（说不定一直不会补上….），几行文字来通天。。。
1.深入理解JNI
2.深入理解Zygote
3.深入理解常见类（未完成）
4.深入理解Binder
5.深入理解Autdio（未完成）
6.深入理解Surface">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解系列：zygote">
<meta property="og:url" content="http://yunfengsa.github.io/2016/04/13/shenruandroid/index.html">
<meta property="og:site_name" content="云枫飒的笔记BLOG">
<meta property="og:description" content="其实文章的开始应该从jni开始才对，脑残的我写完却意外删除了。。。。等缓过来再补上吧（说不定一直不会补上….），几行文字来通天。。。
1.深入理解JNI
2.深入理解Zygote
3.深入理解常见类（未完成）
4.深入理解Binder
5.深入理解Autdio（未完成）
6.深入理解Surface">
<meta property="og:image" content="http://7xnvyl.com1.z0.glb.clouddn.com/2016-4-13zygotefork.JPG">
<meta property="og:updated_time" content="2016-12-07T07:33:47.856Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解系列：zygote">
<meta name="twitter:description" content="其实文章的开始应该从jni开始才对，脑残的我写完却意外删除了。。。。等缓过来再补上吧（说不定一直不会补上….），几行文字来通天。。。
1.深入理解JNI
2.深入理解Zygote
3.深入理解常见类（未完成）
4.深入理解Binder
5.深入理解Autdio（未完成）
6.深入理解Surface">
<meta name="twitter:image" content="http://7xnvyl.com1.z0.glb.clouddn.com/2016-4-13zygotefork.JPG">
  
    <link rel="alternate" href="/atom.xml" title="云枫飒的笔记BLOG" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">云枫飒的笔记BLOG</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">个人技术记录</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yunfengsa.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-shenruandroid" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/13/shenruandroid/" class="article-date">
  <time datetime="2016-04-13T06:06:40.000Z" itemprop="datePublished">2016-04-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      深入理解系列：zygote
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>其实文章的开始应该从jni开始才对，脑残的我写完却意外删除了。。。。等缓过来再补上吧（说不定一直不会补上….），几行文字来通天。。。</p>
<p><a href="www.google.com"><h3>1.深入理解JNI</h3></a></p>
<p><a href="http://yunfengsa.github.io/blog/2016/04/13/shenruandroid/"><h3>2.深入理解Zygote</h3></a></p>
<p><a href="www.google.com"><h3>3.深入理解常见类（未完成）</h3></a></p>
<p><a href="http://yunfengsa.github.io/blog/2016/04/14/shenruandroid-binder/"><h3>4.深入理解Binder</h3></a></p>
<p><a href="www.google.com"><h3>5.深入理解Autdio（未完成）</h3></a></p>
<p><a href="http://yunfengsa.github.io/blog/2016/04/22/shenruandroid-surface/"><h3>6.深入理解Surface</h3></a></p>
<a id="more"></a>
<p>##概述</p>
<p>android是基于linux内核构建的，那必然起于Native，而java又是怎么从Native发起的呢？而这一切则是哼哈二将Zygote（Native程序）和System_server（系统中重要的service）。不清楚native先去看jni吧！</p>
<p>zygote本身是一个Native应用程序，不会涉及到驱动和内核，它是有init进程（Linux）根据init.rc文件创建的。zygote在起始的时候是app_process，然后有linux下的pctrl系统调用换成了zygote。我们在分析zygote的时候发现，其主要的功能实现是AppRuntime的start来完成。</p>
<p>而其主要分三步：</p>
<ul>
<li>创建虚拟机startVm</li>
<li>注册JNI函数startReg</li>
<li>通过JNI调用java函数，调用main函数，总算和java牵涉上点关系了</li>
</ul>
<p>下边展开：</p>
<p><strong>创建虚拟机-startVm：</strong></p>
<p>基本流程是先进行jni-check，然后设置虚拟机headsize，条用JNI_ceateJavaVM创建虚拟机，pEnv返回当前线程的JNIEnv（这货功能可就强大了，对变量的操作全指望它了）</p>
<p><strong>注册JNI函数-startTeg</strong></p>
<p>要使用native函数，注册是必须的，而注册又分为静态注册和动态注册两种，动态注册的过程在系统load动态链接库的时候调用JNi_Onload函数进行注册。通过jniRegisterNativeMethod（env，“xx”，gMethods，NELEM(gMethods)）进行注册，而gMethods返回的就是包含JNINativeMethodStuct的结构体数组（不清楚的可以去看jni喽）。</p>
<p>接下来上桥，我们的java世界的main函数ZygoteInit.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"ZygoteInit"</span>);</div><div class="line">           RuntimeInit.enableDdms();</div><div class="line">           <span class="comment">// Start profiling the zygote initialization.</span></div><div class="line">           SamplingProfilerIntegration.start();                  </div><div class="line"></div><div class="line">           <span class="keyword">boolean</span> startSystemServer = <span class="keyword">false</span>;</div><div class="line">           String socketName = <span class="string">"zygote"</span>;  <span class="comment">//定义socketname</span></div><div class="line">           String abiList = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</div><div class="line">               <span class="keyword">if</span> (<span class="string">"start-system-server"</span>.equals(argv[i])) &#123;</div><div class="line">                   startSystemServer = <span class="keyword">true</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</div><div class="line">                   abiList = argv[i].substring(ABI_LIST_ARG.length());</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</div><div class="line">                   socketName = argv[i].substring(SOCKET_NAME_ARG.length());</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unknown command line argument: "</span> + argv[i]);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (abiList == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No ABI list supplied."</span>);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           registerZygoteSocket(socketName);                 <span class="comment">//1.注册zygote用的socket</span></div><div class="line">           Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"ZygotePreload"</span>);</div><div class="line">           EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</div><div class="line">               SystemClock.uptimeMillis());</div><div class="line">           preload();                                  <span class="comment">//2.预加载类和资源</span></div><div class="line">           EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</div><div class="line">               SystemClock.uptimeMillis());</div><div class="line">           Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line"></div><div class="line">           <span class="comment">// Finish profiling the zygote initialization.</span></div><div class="line">           SamplingProfilerIntegration.writeZygoteSnapshot();</div><div class="line"></div><div class="line">           <span class="comment">// Do an initial gc to clean up after startup</span></div><div class="line">           Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PostZygoteInitGC"</span>);</div><div class="line">           gcAndFinalize();</div><div class="line">           Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line"></div><div class="line">           Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line"></div><div class="line">           <span class="comment">// Disable tracing so that forked processes do not inherit stale tracing tags from</span></div><div class="line">           <span class="comment">// Zygote.</span></div><div class="line">           Trace.setTracingEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">           <span class="comment">// Zygote process unmounts root storage spaces.</span></div><div class="line">           Zygote.nativeUnmountStorageOnInit();</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (startSystemServer) &#123;</div><div class="line">               startSystemServer(abiList, socketName);       <span class="comment">//3.启动system_server进程，java的另一片天。</span></div><div class="line">           &#125;</div><div class="line"></div><div class="line">           Log.i(TAG, <span class="string">"Accepting command socket connections"</span>);</div><div class="line">           runSelectLoop(abiList);                        <span class="comment">//4.zygote调用这个函数</span></div><div class="line"></div><div class="line">           closeServerSocket();      </div><div class="line">       &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</div><div class="line">           caller.run();                        <span class="comment">//5.很强大的样子，前方高能</span></div><div class="line">       &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</div><div class="line">           Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</div><div class="line">           closeServerSocket();</div><div class="line">           <span class="keyword">throw</span> ex;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>对代码中列出的五点进行简单分析：</p>
<ul>
<li>1.建立IPC通信服务-regisZygoteSocket:zygote和系统中其他程序的通信没有使用Binder，而是使用Socket，而这里创建的是服务端socket，静等客户端。。客户端是啥呢？</li>
<li>2.预加载类和资源</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"begin preload"</span>);</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PreloadClasses"</span>);</div><div class="line">        preloadClasses();                     <span class="comment">//预加载类</span></div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PreloadResources"</span>);</div><div class="line">        preloadResources();   <span class="comment">//预加载资源</span></div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PreloadOpenGL"</span>);</div><div class="line">        preloadOpenGL();    <span class="comment">//预加载openGL</span></div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">        preloadSharedLibraries();    <span class="comment">//预加载分享库</span></div><div class="line">        preloadTextResources();       <span class="comment">//预加载TextResourrces</span></div><div class="line">        <span class="comment">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span></div><div class="line">        <span class="comment">// for memory sharing purposes.</span></div><div class="line">        WebViewFactory.prepareWebViewInZygote();   <span class="comment">//webview初始化</span></div><div class="line">        Log.d(TAG, <span class="string">"end preload"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">//以preload为例</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preloadClasses</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> VMRuntime runtime = VMRuntime.getRuntime();</div><div class="line"></div><div class="line">        InputStream is;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            is = <span class="keyword">new</span> FileInputStream(PRELOADED_CLASSES);  <span class="comment">//private static final String PRELOADED_CLASSES = "/system/etc/preloaded-classes";</span></div><div class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Couldn't find "</span> + PRELOADED_CLASSES + <span class="string">"."</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Log.i(TAG, <span class="string">"Preloading classes..."</span>);</div><div class="line">        <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</div><div class="line"></div><div class="line">        <span class="comment">// Drop root perms while running static initializers.</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> reuid = Os.getuid();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> regid = Os.getgid();</div><div class="line"></div><div class="line">        <span class="comment">// We need to drop root perms only if we're already root. In the case of "wrapped"</span></div><div class="line">        <span class="comment">// processes (see WrapperInit), this function is called from an unprivileged uid</span></div><div class="line">        <span class="comment">// and gid.</span></div><div class="line">        <span class="keyword">boolean</span> droppedPriviliges = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (reuid == ROOT_UID &amp;&amp; regid == ROOT_GID) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Os.setregid(ROOT_GID, UNPRIVILEGED_GID);</div><div class="line">                Os.setreuid(ROOT_UID, UNPRIVILEGED_UID);</div><div class="line">            &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to drop root"</span>, ex);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            droppedPriviliges = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Alter the target heap utilization.  With explicit GCs this</span></div><div class="line">        <span class="comment">// is not likely to have any effect.</span></div><div class="line">        <span class="keyword">float</span> defaultUtilization = runtime.getTargetHeapUtilization();</div><div class="line">        runtime.setTargetHeapUtilization(<span class="number">0.8f</span>);</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            BufferedReader br</div><div class="line">                = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is), <span class="number">256</span>);</div><div class="line"></div><div class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">            String line;</div><div class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Skip comments and blank lines.</span></div><div class="line">                line = line.trim();</div><div class="line">                <span class="keyword">if</span> (line.startsWith(<span class="string">"#"</span>) || line.equals(<span class="string">""</span>)) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PreloadClass "</span> + line);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">                        Log.v(TAG, <span class="string">"Preloading "</span> + line + <span class="string">"..."</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// Load and explicitly initialize the given class. Use</span></div><div class="line">                    <span class="comment">// Class.forName(String, boolean, ClassLoader) to avoid repeated stack lookups</span></div><div class="line">                    <span class="comment">// (to derive the caller's class-loader). Use true to force initialization, and</span></div><div class="line">                    <span class="comment">// null for the boot classpath class-loader (could as well cache the</span></div><div class="line">                    <span class="comment">// class-loader of this class in a variable).</span></div><div class="line">                    Class.forName(line, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">                    count++;</div><div class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                    Log.w(TAG, <span class="string">"Class not found for preloading: "</span> + line);</div><div class="line">                &#125; <span class="keyword">catch</span> (UnsatisfiedLinkError e) &#123;</div><div class="line">                    Log.w(TAG, <span class="string">"Problem preloading "</span> + line + <span class="string">": "</span> + e);</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    Log.e(TAG, <span class="string">"Error preloading "</span> + line + <span class="string">"."</span>, t);</div><div class="line">                    <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Error) &#123;</div><div class="line">                        <span class="keyword">throw</span> (Error) t;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (t <span class="keyword">instanceof</span> RuntimeException) &#123;</div><div class="line">                        <span class="keyword">throw</span> (RuntimeException) t;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(t);</div><div class="line">                &#125;</div><div class="line">                Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Log.i(TAG, <span class="string">"...preloaded "</span> + count + <span class="string">" classes in "</span></div><div class="line">                    + (SystemClock.uptimeMillis()-startTime) + <span class="string">"ms."</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Error reading "</span> + PRELOADED_CLASSES + <span class="string">"."</span>, e);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            IoUtils.closeQuietly(is);</div><div class="line">            <span class="comment">// Restore default.</span></div><div class="line">            runtime.setTargetHeapUtilization(defaultUtilization);</div><div class="line"></div><div class="line">            <span class="comment">// Fill in dex caches with classes, fields, and methods brought in by preloading.</span></div><div class="line">            Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">"PreloadDexCaches"</span>);</div><div class="line">            runtime.preloadDexCaches();</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line"></div><div class="line">            <span class="comment">// Bring back root. We'll need it later if we're in the zygote.</span></div><div class="line">            <span class="keyword">if</span> (droppedPriviliges) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Os.setreuid(ROOT_UID, ROOT_UID);</div><div class="line">                    Os.setregid(ROOT_GID, ROOT_GID);</div><div class="line">                &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to restore root"</span>, ex);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>代码那么多无非是从 “/system/etc/preloaded-classes”文件中获取流，然后<code>Class.forName(line, true, null);</code>获取到类，我们在编写UI的时候用到的com.android.R.xxx资源也都是系统默认的资源，他们就是在zygote加载的</p>
<ul>
<li>3.启动system_server:创建java世界中系统Service所驻留的进程system_server，它死了zygote也完蛋。</li>
</ul>
<p>函数也在ZygoteInit中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span></div><div class="line">           <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException &#123;</div><div class="line">       <span class="keyword">long</span> capabilities = posixCapabilitiesAsBits(</div><div class="line">           OsConstants.CAP_BLOCK_SUSPEND,</div><div class="line">           OsConstants.CAP_KILL,</div><div class="line">           OsConstants.CAP_NET_ADMIN,</div><div class="line">           OsConstants.CAP_NET_BIND_SERVICE,</div><div class="line">           OsConstants.CAP_NET_BROADCAST,</div><div class="line">           OsConstants.CAP_NET_RAW,</div><div class="line">           OsConstants.CAP_SYS_MODULE,</div><div class="line">           OsConstants.CAP_SYS_NICE,</div><div class="line">           OsConstants.CAP_SYS_RESOURCE,</div><div class="line">           OsConstants.CAP_SYS_TIME,</div><div class="line">           OsConstants.CAP_SYS_TTY_CONFIG</div><div class="line">       );</div><div class="line">       <span class="comment">/* Hardcoded command line to start the system server */</span></div><div class="line">       String args[] = &#123;</div><div class="line">           <span class="string">"--setuid=1000"</span>,</div><div class="line">           <span class="string">"--setgid=1000"</span>,</div><div class="line">           <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007,3009,3010"</span>,</div><div class="line">           <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</div><div class="line">           <span class="string">"--nice-name=system_server"</span>,</div><div class="line">           <span class="string">"--runtime-args"</span>,</div><div class="line">           <span class="string">"com.android.server.SystemServer"</span>,</div><div class="line">       &#125;;</div><div class="line">       ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">       <span class="keyword">int</span> pid;</div><div class="line"></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</div><div class="line">           ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</div><div class="line">           ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</div><div class="line"></div><div class="line">           <span class="comment">/* Request to fork the system server process */</span></div><div class="line">           pid = Zygote.forkSystemServer(                    <span class="comment">//原来就是由Zygote分裂出来的啊</span></div><div class="line">                   parsedArgs.uid, parsedArgs.gid,</div><div class="line">                   parsedArgs.gids,</div><div class="line">                   parsedArgs.debugFlags,</div><div class="line">                   <span class="keyword">null</span>,</div><div class="line">                   parsedArgs.permittedCapabilities,</div><div class="line">                   parsedArgs.effectiveCapabilities);</div><div class="line">       &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/* For child process */</span></div><div class="line">       <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</div><div class="line">               waitForSecondaryZygote(socketName);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           handleSystemServerProcess(parsedArgs);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>关键的依据<code>Zygote.forkSystemServer</code></p>
<ul>
<li>4.有求必应之等待请求-runSelectLoop(abiList);</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> <span class="keyword">throws</span> MethodAndArgsCaller </span>&#123;</div><div class="line">        ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</div><div class="line">        ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</div><div class="line"></div><div class="line">        fds.add(sServerSocket.getFileDescriptor());</div><div class="line">        peers.add(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</div><div class="line">                pollFds[i] = <span class="keyword">new</span> StructPollfd();</div><div class="line">                pollFds[i].fd = fds.get(i);</div><div class="line">                pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Os.poll(pollFds, -<span class="number">1</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</div><div class="line">                <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</div><div class="line">                    ZygoteConnection newPeer = acceptCommandPeer(abiList);</div><div class="line">                    peers.add(newPeer);</div><div class="line">                    fds.add(newPeer.getFileDesciptor());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">boolean</span> done = peers.get(i).runOnce();</div><div class="line">                    <span class="keyword">if</span> (done) &#123;</div><div class="line">                        peers.remove(i);</div><div class="line">                        fds.remove(i);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>在这里就需要我们第一步创建的socket，当时我们创建的是一个服务端socket，这里进行处理客户端连接和请求，其中客户在zygote中用ZygoteConnection对象来表示，客户的请求有ZygoteConnection的runOnce来处理.</p>
<p>zygote：</p>
<ol>
<li>它第一天创建了AppRuntime，并start，把权力交给了他。</li>
<li>第二天，启动虚拟机，并注册jni</li>
<li>第三天，通过jni调用ZygoteInit的main函数，正式开启java</li>
<li>第四天，条用了registerZygoteSocket,通过这个函数，它可以相响应子孙的请求。同时进行preload</li>
<li>第五天，通过startSystemServer分裂一个子进程system_server来为java世界服务</li>
<li>第六天，哥累了，调用runSelectLoop来处理客户端的连接，让哥睡会。</li>
</ol>
<p>##SystemServer（作为zygote的嫡长子，使命那是大大滴，不做昏君，打理朝政）</p>
<p>他是由zygote通过fork（）而来，并且与zygote同生死，创建完成后通过handleSystemServerProcess来处理朝政</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleSystemServerProcess</span><span class="params">(</span></span></div><div class="line">            ZygoteConnection.Arguments parsedArgs)</div><div class="line">            <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line"></div><div class="line">        closeServerSocket();   <span class="comment">//关闭继承来的socket</span></div><div class="line"></div><div class="line">        <span class="comment">// set umask to 0077 so new files and directories will default to owner-only permissions.</span></div><div class="line">        Os.umask(S_IRWXG | S_IRWXO);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</div><div class="line">            Process.setArgV0(parsedArgs.niceName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> String systemServerClasspath = Os.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</div><div class="line">        <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</div><div class="line">            performSystemServerDexOpt(systemServerClasspath);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</div><div class="line">            String[] args = parsedArgs.remainingArgs;</div><div class="line">            <span class="comment">// If we have a non-null system server class path, we'll have to duplicate the</span></div><div class="line">            <span class="comment">// existing arguments and append the classpath to it. ART will handle the classpath</span></div><div class="line">            <span class="comment">// correctly when we exec a new process.</span></div><div class="line">            <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</div><div class="line">                String[] amendedArgs = <span class="keyword">new</span> String[args.length + <span class="number">2</span>];</div><div class="line">                amendedArgs[<span class="number">0</span>] = <span class="string">"-cp"</span>;</div><div class="line">                amendedArgs[<span class="number">1</span>] = systemServerClasspath;</div><div class="line">                System.arraycopy(parsedArgs.remainingArgs, <span class="number">0</span>, amendedArgs, <span class="number">2</span>, parsedArgs.remainingArgs.length);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            WrapperInit.execApplication(parsedArgs.invokeWith,</div><div class="line">                    parsedArgs.niceName, parsedArgs.targetSdkVersion,</div><div class="line">                    VMRuntime.getCurrentInstructionSet(), <span class="keyword">null</span>, args);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ClassLoader cl = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</div><div class="line">                cl = <span class="keyword">new</span> PathClassLoader(systemServerClasspath, ClassLoader.getSystemClassLoader());</div><div class="line">                Thread.currentThread().setContextClassLoader(cl);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Pass the remaining arguments to SystemServer.</div><div class="line">             */</div><div class="line">            RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);    <span class="comment">//进行初始化</span></div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>接下来看zygoteInit</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></div><div class="line">           <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">       <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting application from zygote"</span>);</div><div class="line"></div><div class="line">       Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"RuntimeInit"</span>);</div><div class="line">       redirectLogStreams();</div><div class="line"></div><div class="line">       commonInit();  <span class="comment">//基本初始化</span></div><div class="line">       nativeZygoteInit(); <span class="comment">//native层的初始化</span></div><div class="line">       applicationInit(targetSdkVersion, argv, classLoader);  <span class="comment">//application 初始化</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>就是在native层的初始化之后在onZygoteInit中与Binder通信系统建立联系。在applicationInit中会抛出一个异常，而捕获这个异常的时候就开始执行systemserver的main函数调用。干嘛这么搞，好像有点别扭啊，比较合理的解释是：<strong>这个调用在ZygoteInit.main中，相当于Native的入口函数位于堆栈的顶层，如果不这样的话，在初始化里边掉用，则会浪费之前的函数调用所占用的一些调用堆栈</strong></p>
<p>以上完成了调用，现在该梳理SystemServer.java了,这里要说明的是选用的21以上的版本的代码，之前的会有出入，但基本流程不会发生变化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> SystemServer().run();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SystemServer</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Check for factory test mode.</span></div><div class="line">        mFactoryTestMode = FactoryTest.getMode();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;											<span class="comment">//设置系统相关属性</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"InitBeforeStartServices"</span>);</div><div class="line">            <span class="comment">// If a device's clock is before 1970 (before 0), a lot of</span></div><div class="line">            <span class="comment">// APIs crash dealing with negative numbers, notably</span></div><div class="line">            <span class="comment">// java.io.File#setLastModified, so instead we fake it and</span></div><div class="line">            <span class="comment">// hope that time from cell towers or NTP fixes it shortly.</span></div><div class="line">            <span class="keyword">if</span> (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) &#123;</div><div class="line">                Slog.w(TAG, <span class="string">"System clock is before 1970; setting to 1970."</span>);</div><div class="line">                SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// If the system has "persist.sys.language" and friends set, replace them with</span></div><div class="line">            <span class="comment">// "persist.sys.locale". Note that the default locale at this point is calculated</span></div><div class="line">            <span class="comment">// using the "-Duser.locale" command line flag. That flag is usually populated by</span></div><div class="line">            <span class="comment">// AndroidRuntime using the same set of system properties, but only the system_server</span></div><div class="line">            <span class="comment">// and system apps are allowed to set them.</span></div><div class="line">            <span class="comment">//																							</span></div><div class="line">            <span class="comment">// <span class="doctag">NOTE:</span> Most changes made here will need an equivalent change to</span></div><div class="line">            <span class="comment">// core/jni/AndroidRuntime.cpp</span></div><div class="line">            <span class="keyword">if</span> (!SystemProperties.get(<span class="string">"persist.sys.language"</span>).isEmpty()) &#123;</div><div class="line">                <span class="keyword">final</span> String languageTag = Locale.getDefault().toLanguageTag();</div><div class="line"></div><div class="line">                SystemProperties.set(<span class="string">"persist.sys.locale"</span>, languageTag);</div><div class="line">                SystemProperties.set(<span class="string">"persist.sys.language"</span>, <span class="string">""</span>);</div><div class="line">                SystemProperties.set(<span class="string">"persist.sys.country"</span>, <span class="string">""</span>);</div><div class="line">                SystemProperties.set(<span class="string">"persist.sys.localevar"</span>, <span class="string">""</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Here we go!</span></div><div class="line">            Slog.i(TAG, <span class="string">"Entered the Android system server!"</span>);</div><div class="line">            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, SystemClock.uptimeMillis());</div><div class="line"></div><div class="line">            <span class="comment">// In case the runtime switched since last boot (such as when</span></div><div class="line">            <span class="comment">// the old runtime was removed in an OTA), set the system</span></div><div class="line">            <span class="comment">// property so that it is in sync. We can't do this in</span></div><div class="line">            <span class="comment">// libnativehelper's JniInvocation::Init code where we already</span></div><div class="line">            <span class="comment">// had to fallback to a different runtime because it is</span></div><div class="line">            <span class="comment">// running as root and we need to be the system user to set</span></div><div class="line">            <span class="comment">// the property. http://b/11463182</span></div><div class="line">            SystemProperties.set(<span class="string">"persist.sys.dalvik.vm.lib.2"</span>, VMRuntime.getRuntime().vmLibrary());</div><div class="line"></div><div class="line">            <span class="comment">// Enable the sampling profiler.</span></div><div class="line">            <span class="keyword">if</span> (SamplingProfilerIntegration.isEnabled()) &#123;</div><div class="line">                SamplingProfilerIntegration.start();</div><div class="line">                mProfilerSnapshotTimer = <span class="keyword">new</span> Timer();</div><div class="line">                mProfilerSnapshotTimer.schedule(<span class="keyword">new</span> TimerTask() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            SamplingProfilerIntegration.writeSnapshot(<span class="string">"system_server"</span>, <span class="keyword">null</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Mmmmmm... more memory!                  </span></div><div class="line">            VMRuntime.getRuntime().clearGrowthLimit();   <span class="comment">//获取更大的内存</span></div><div class="line"></div><div class="line">            <span class="comment">// The system server has to run all of the time, so it needs to be</span></div><div class="line">            <span class="comment">// as efficient as possible with its memory usage.</span></div><div class="line">            VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.8f</span>);</div><div class="line"></div><div class="line">            <span class="comment">// Some devices rely on runtime fingerprint generation, so make sure</span></div><div class="line">            <span class="comment">// we've defined it before booting further.</span></div><div class="line">            Build.ensureFingerprintProperty();</div><div class="line"></div><div class="line">            <span class="comment">// Within the system server, it is an error to access Environment paths without</span></div><div class="line">            <span class="comment">// explicitly specifying a user.</span></div><div class="line">            Environment.setUserRequired(<span class="keyword">true</span>);   <span class="comment">//系统变量</span></div><div class="line"></div><div class="line">            <span class="comment">// Ensure binder calls into the system always run at foreground priority.</span></div><div class="line">            BinderInternal.disableBackgroundScheduling(<span class="keyword">true</span>);    <span class="comment">//提高binder的优先级</span></div><div class="line"></div><div class="line">            <span class="comment">// Prepare the main looper thread (this thread).</span></div><div class="line">            android.os.Process.setThreadPriority(           <span class="comment">//注意这里提高线程的优先级，准备主线程</span></div><div class="line">                android.os.Process.THREAD_PRIORITY_FOREGROUND);</div><div class="line">            android.os.Process.setCanSelfBackground(<span class="keyword">false</span>);</div><div class="line">            Looper.prepareMainLooper();</div><div class="line"></div><div class="line">            <span class="comment">// Initialize native services.            </span></div><div class="line">            System.loadLibrary(<span class="string">"android_servers"</span>);  <span class="comment">//加载libandroid_servers.so</span></div><div class="line"></div><div class="line">            <span class="comment">// Check whether we failed to shut down last time we tried.</span></div><div class="line">            <span class="comment">// This call may not return.</span></div><div class="line">            performPendingShutdown();</div><div class="line"></div><div class="line">            <span class="comment">// Initialize the system context. //初始化上下文</span></div><div class="line">            createSystemContext();</div><div class="line"></div><div class="line">            <span class="comment">// Create the system service manager.</span></div><div class="line">            mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);   <span class="comment">//这里开始创建SystemServiceManager</span></div><div class="line">            LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Start services.   //启动各大服务</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"StartServices"</span>);</div><div class="line">            startBootstrapServices();</div><div class="line">            startCoreServices();</div><div class="line">            startOtherServices();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">            Slog.e(<span class="string">"System"</span>, <span class="string">"******************************************"</span>);</div><div class="line">            Slog.e(<span class="string">"System"</span>, <span class="string">"************ Failure starting system services"</span>, ex);</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// For debug builds, log event loop stalls to dropbox for analysis.</span></div><div class="line">        <span class="keyword">if</span> (StrictMode.conditionallyEnableDebugLogging()) &#123;</div><div class="line">            Slog.i(TAG, <span class="string">"Enabled StrictMode for system server main thread."</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Loop forever.</span></div><div class="line">        Looper.loop();</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>其基本流程：</p>
<ol>
<li>zygote通过startSystemServer生成了嫡长子system_server；</li>
<li>ss条用handleSystemServerProcess完成自己使命</li>
<li>然后完成一些初始化的后，通过一场抛出的方式执行SystemServer的main函数，</li>
<li>加载.so库，并启动相关service</li>
<li>并且加入binder通信系统，而且会提高优先级，同时再次还会初始化主线程。</li>
</ol>
<p>##前文提到zygote会开启服务端Socket，那他是怎么被请求呢，</p>
<p>前文分析中已说明，通过runSelectLoopMode处理socket请求</p>
<p><strong>ActivityManagerService例子说明一切</strong></p>
<p>ActivityManagerService也是由SystemServer创建的，那他是怎么startActivity的呢？这之中startProcessLocked代码很多，关键部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Process.ProcessStartResult startResult = Process.start(entryPoint,</div><div class="line">                    app.processName, uid, uid, gids, debugFlags, mountExternal,</div><div class="line">                    app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</div><div class="line">                    app.info.dataDir, entryPointArgs);</div><div class="line">            checkTime(startTime, <span class="string">"startProcess: returned from zygote!"</span>);</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div></pre></td></tr></table></figure>
<p>这个Process就是关键，这个Process是android提供的，会通过其内部函数<code>openZygoteSocketIfNeedEd</code>发起socket连接，<em>ActivityManagerService驻留于SystemServer进程中，所以也就是SS想zygote发送的消息（请求参数有一个字符串：android.app.ActivityThread）</em>，那么在ZygoteInit通过runSelectLoopmode对其进行处理，还记得客户端在zygote都被用zugoteConnection来表示，而连接之后则会调用其runOnce()：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">runOnce</span><span class="params">()</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</div><div class="line"></div><div class="line">        String args[];</div><div class="line">        Arguments parsedArgs = <span class="keyword">null</span>;</div><div class="line">        FileDescriptor[] descriptors;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            args = readArgumentList();</div><div class="line">            descriptors = mSocket.getAncillaryFileDescriptors();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">            Log.w(TAG, <span class="string">"IOException on command socket "</span> + ex.getMessage());</div><div class="line">            closeSocket();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// EOF reached.</span></div><div class="line">            closeSocket();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/** the stderr of the most recent request, if avail */</span></div><div class="line">        PrintStream newStderr = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (descriptors != <span class="keyword">null</span> &amp;&amp; descriptors.length &gt;= <span class="number">3</span>) &#123;</div><div class="line">            newStderr = <span class="keyword">new</span> PrintStream(</div><div class="line">                    <span class="keyword">new</span> FileOutputStream(descriptors[<span class="number">2</span>]));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> pid = -<span class="number">1</span>;</div><div class="line">        FileDescriptor childPipeFd = <span class="keyword">null</span>;</div><div class="line">        FileDescriptor serverPipeFd = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parsedArgs = <span class="keyword">new</span> Arguments(args);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (parsedArgs.abiListQuery) &#123;</div><div class="line">                <span class="keyword">return</span> handleAbiListQuery();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (parsedArgs.permittedCapabilities != <span class="number">0</span> || parsedArgs.effectiveCapabilities != <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteSecurityException(<span class="string">"Client may not specify capabilities: "</span> +</div><div class="line">                        <span class="string">"permitted=0x"</span> + Long.toHexString(parsedArgs.permittedCapabilities) +</div><div class="line">                        <span class="string">", effective=0x"</span> + Long.toHexString(parsedArgs.effectiveCapabilities));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            applyUidSecurityPolicy(parsedArgs, peer);</div><div class="line">            applyInvokeWithSecurityPolicy(parsedArgs, peer);</div><div class="line"></div><div class="line">            applyDebuggerSystemProperty(parsedArgs);</div><div class="line">            applyInvokeWithSystemProperty(parsedArgs);</div><div class="line"></div><div class="line">            <span class="keyword">int</span>[][] rlimits = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (parsedArgs.rlimits != <span class="keyword">null</span>) &#123;</div><div class="line">                rlimits = parsedArgs.rlimits.toArray(intArray2d);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</div><div class="line">                FileDescriptor[] pipeFds = Os.pipe2(O_CLOEXEC);</div><div class="line">                childPipeFd = pipeFds[<span class="number">1</span>];</div><div class="line">                serverPipeFd = pipeFds[<span class="number">0</span>];</div><div class="line">                Os.fcntlInt(childPipeFd, F_SETFD, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line">             * In order to avoid leaking descriptors to the Zygote child,</div><div class="line">             * the native code must close the two Zygote socket descriptors</div><div class="line">             * in the child process before it switches from Zygote-root to</div><div class="line">             * the UID and privileges of the application being launched.</div><div class="line">             *</div><div class="line">             * In order to avoid "bad file descriptor" errors when the</div><div class="line">             * two LocalSocket objects are closed, the Posix file</div><div class="line">             * descriptors are released via a dup2() call which closes</div><div class="line">             * the socket and substitutes an open descriptor to /dev/null.</div><div class="line">             */</div><div class="line"></div><div class="line">            <span class="keyword">int</span> [] fdsToClose = &#123; -<span class="number">1</span>, -<span class="number">1</span> &#125;;</div><div class="line"></div><div class="line">            FileDescriptor fd = mSocket.getFileDescriptor();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</div><div class="line">                fdsToClose[<span class="number">0</span>] = fd.getInt$();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            fd = ZygoteInit.getServerSocketFileDescriptor();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</div><div class="line">                fdsToClose[<span class="number">1</span>] = fd.getInt$();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            fd = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</div><div class="line">                    parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</div><div class="line">                    parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,</div><div class="line">                    parsedArgs.appDataDir);     			<span class="comment">//进行fork</span></div><div class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">            logAndPrintError(newStderr, <span class="string">"Exception creating pipe"</span>, ex);</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">            logAndPrintError(newStderr, <span class="string">"Invalid zygote arguments"</span>, ex);</div><div class="line">        &#125; <span class="keyword">catch</span> (ZygoteSecurityException ex) &#123;</div><div class="line">            logAndPrintError(newStderr,</div><div class="line">                    <span class="string">"Zygote security policy prevents request: "</span>, ex);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// in child</span></div><div class="line">                IoUtils.closeQuietly(serverPipeFd);</div><div class="line">                serverPipeFd = <span class="keyword">null</span>;</div><div class="line">                handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);       <span class="comment">//对创建的子线程进行处理</span></div><div class="line"></div><div class="line">                <span class="comment">// should never get here, the child is expected to either</span></div><div class="line">                <span class="comment">// throw ZygoteInit.MethodAndArgsCaller or exec().</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// in parent...pid of &lt; 0 means failure</span></div><div class="line">                IoUtils.closeQuietly(childPipeFd);</div><div class="line">                childPipeFd = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            IoUtils.closeQuietly(childPipeFd);</div><div class="line">            IoUtils.closeQuietly(serverPipeFd);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">handleAbiListQuery</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] abiListBytes = abiList.getBytes(StandardCharsets.US_ASCII);</div><div class="line">            mSocketOutStream.writeInt(abiListBytes.length);</div><div class="line">            mSocketOutStream.write(abiListBytes);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Error writing to command socket"</span>, ioe);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div></pre></td></tr></table></figure>
<p>handleChildProc：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleChildProc</span><span class="params">(Arguments parsedArgs,</span></span></div><div class="line">            FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)</div><div class="line">            <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * By the time we get here, the native code has closed the two actual Zygote</div><div class="line">         * socket connections, and substituted /dev/null in their place.  The LocalSocket</div><div class="line">         * objects still need to be closed properly.</div><div class="line">         */</div><div class="line"></div><div class="line">        closeSocket();</div><div class="line">        ZygoteInit.closeServerSocket();  <span class="comment">//关闭继承来的socket</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (descriptors != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Os.dup2(descriptors[<span class="number">0</span>], STDIN_FILENO);</div><div class="line">                Os.dup2(descriptors[<span class="number">1</span>], STDOUT_FILENO);</div><div class="line">                Os.dup2(descriptors[<span class="number">2</span>], STDERR_FILENO);</div><div class="line"></div><div class="line">                <span class="keyword">for</span> (FileDescriptor fd: descriptors) &#123;</div><div class="line">                    IoUtils.closeQuietly(fd);</div><div class="line">                &#125;</div><div class="line">                newStderr = System.err;</div><div class="line">            &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">                Log.e(TAG, <span class="string">"Error reopening stdio"</span>, ex);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</div><div class="line">            Process.setArgV0(parsedArgs.niceName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// End of the postFork event.</span></div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">        <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</div><div class="line">            WrapperInit.execApplication(parsedArgs.invokeWith,</div><div class="line">                    parsedArgs.niceName, parsedArgs.targetSdkVersion,</div><div class="line">                    VMRuntime.getCurrentInstructionSet(),</div><div class="line">                    pipeFd, parsedArgs.remainingArgs);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion,               <span class="comment">//进行zygote初始化</span></div><div class="line">                    parsedArgs.remainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>接着电泳zygoteInit初始化工作，从这里便会开始执行main（invokeStatimain）喽</p>
<p><strong>android.app.ActivityThread也就是我们apk的main函数，显而易见apk都是zygote的儿子</strong></p>
<p>zygote是SS的爸爸，但是要不要兄弟，还是SS来控制的,其基本流程如下：</p>
<p><img src="http://7xnvyl.com1.z0.glb.clouddn.com/2016-4-13zygotefork.JPG" alt=""></p>
<p>##到此zygote已经分析的差不多鸟，拓展点：</p>
<p>####开机速度影响因素</p>
<ul>
<li>preload()预加载，包裹预加载类，系统资源，以及webview准备等等</li>
<li>对apk信息进行收集</li>
<li>SS创建的那些service</li>
</ul>
<p>####虚拟机heapsize的限制</p>
<p>这个值可以被更改，各大厂商的根据定制会自行调整，16、32、64不等，当前主流的应该是64M，由于fork机制导致我们不能动态调节heapsize，解决思路有两个</p>
<p><em>　虚拟机自己去搞
</em>　ｆｏｒｋ之后用ｅｘｅｃ家族函数重新创建虚拟机重新ｊｎｉ重新ｚｙｇｏｔｅ两片天，只能说能行，但是貌似不可行。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yunfengsa.github.io/2016/04/13/shenruandroid/" data-id="ciwemrtxm0013hwrixb4lwy3v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/04/14/shenruandroid-binder/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          深入理解系列：Binder
        
      </div>
    </a>
  
  
    <a href="/2016/04/12/volleyyuanma/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Volley源码解析</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Chromium/">Chromium</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ruby/">Ruby</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gradle/">gradle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ndk/">ndk</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/octopress/">octopress</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/opencv/">opencv</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/rails/">rails</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ruby/">ruby</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/rx/">rx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/weex/">weex</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/binder/">binder</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/surface/">surface</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/binder/" style="font-size: 10px;">binder</a> <a href="/tags/surface/" style="font-size: 10px;">surface</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/11/28/weex-and-vue-and-so-on/">开启Vue学习之旅</a>
          </li>
        
          <li>
            <a href="/2016/11/07/rx-to-retrofit-and-so-on/">Rx的进攻路线（选取比较好的文章）</a>
          </li>
        
          <li>
            <a href="/2016/11/06/find-a-way-to-gesturerecognization/">Find A Way to Gesture Recognization</a>
          </li>
        
          <li>
            <a href="/2016/11/02/camkeandopencv/">CMake编译NDK，以及在OpenCV中的应用</a>
          </li>
        
          <li>
            <a href="/2016/10/17/make-gradle-faster/">加速Gradle之路</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 yunfengsa<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>